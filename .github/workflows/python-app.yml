name: å®œæ˜Œå¸‚ä¿¡ç”¨æ•°æ®è‡ªåŠ¨é‡‡é›†

on:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤©UTCæ—¶é—´20:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥04:00ï¼‰
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  data-collect:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pycryptodome==3.19.1 requests==2.31.0 openpyxl==3.1.2

    - name: æ‰§è¡Œæ•°æ®é‡‡é›†
      id: export
      run: |
        # ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆPythonä¾§ç”Ÿæˆï¼‰
        ts=$(python3 -c "from datetime import datetime; print(datetime.now().strftime('%Y%m%d%H%M'))")
        
        # æ¸…ç†å†å²æ–‡ä»¶
        find excel_output/ -maxdepth 1 -type f -name "*.xlsx" -delete
        
        # æ‰§è¡Œé‡‡é›†è„šæœ¬å¹¶ä¼ é€’æ—¶é—´æˆ³
        python3 main.py $ts
        
        # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
        if [ ! -f "excel_output/å®œæ˜Œå¸‚ä¿¡ç”¨æ•°æ®_${ts}.xlsx" ]; then
            echo "::error:: æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
        fi
        echo "file-path=excel_output/å®œæ˜Œå¸‚ä¿¡ç”¨æ•°æ®_${ts}.xlsx" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ æ•°æ®æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: enterprise-data
        path: ${{ steps.export.outputs.file-path }}
        retention-days: 7

    - name: æäº¤åˆ°ä»“åº“
      run: |
        # é…ç½®Gitèº«ä»½
        git config user.name "coomaso"
        git config user.email "coomaso@gmail.com"
        
        # åˆ›å»ºå†å²æ•°æ®ç›®å½•
        mkdir -p historical_data
        
        # è·å–æ—¶é—´æˆ³
        ts=${{ steps.export.outputs.ts }}
        
        # ç§»åŠ¨æ–‡ä»¶åˆ°å†å²ç›®å½•ï¼ˆä¿ç•™åŸæ–‡ä»¶åï¼‰
        if [ -f "${{ steps.export.outputs.file-path }}" ]; then
          mv "${{ steps.export.outputs.file-path }}" "historical_data/"
        else
          echo "::warning:: æœªæ‰¾åˆ°éœ€è¦æäº¤çš„æ–‡ä»¶"
          exit 0
        fi
        
        # æäº¤å˜æ›´
        git add .
        git commit -m "ğŸ“Š ä¿¡ç”¨æ•°æ®æ›´æ–° [$ts]" || echo "æ²¡æœ‰å˜æ›´å¯æäº¤"
        git push origin main --force
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
