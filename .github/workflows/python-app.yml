name: 宜昌市信用数据自动采集

on:
  schedule:
    - cron: '0 20 * * *'  # 每天UTC时间20:00运行（北京时间次日04:00）
  push:
    branches: [ "main" ]
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write
  actions: write

jobs:
  data-collect:
    runs-on: ubuntu-latest
    outputs:
      excel-file: ${{ steps.export.outputs.file-path }}

    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # 获取完整提交历史

    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pycryptodome requests openpyxl

    - name: 执行数据采集
      id: export
      run: |
        python3 main.py
        echo "file-path=$(ls excel_output/*.xlsx)" >> $GITHUB_OUTPUT

    - name: 上传数据文件
      uses: actions/upload-artifact@v3
      with:
        name: enterprise-data
        path: ${{ steps.export.outputs.file-path }}
        retention-days: 7

    - name: 提交到仓库
      run: |
        # 配置Git身份
        git config user.name "coomaso"
        git config user.email "coomaso@gmail.com"

        # 移动文件到目标目录
        mkdir -p historical_data
        cp ${{ steps.export.outputs.file-path }} historical_data/

        # 添加并提交
        git add historical_data/
        git commit -m "📊 自动更新信用数据 ($(date +'%Y-%m-%d %H:%M'))" || echo "没有变更可提交"
        
        # 强制推送（处理历史重写）
        git push origin main --force
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
